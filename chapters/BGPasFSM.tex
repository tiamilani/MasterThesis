\chapter{The Protocol as a Finite State Machine}
\label{cha:bgp_fsm}

The incremental nature of \ac{BGP} suggests that is possible to study the
evolution of the protocol looking to the events that has been triggered
and the causes of them.
A model that can give this sort of information would be helpful to debug 
the protocol, analyze faulty situations or prevent them.
The main idea behind this model of the protocol has been taken and 
expanded from \cite{griffinFSM}.
I'm going to show that infering information from \ac{BGP} events and actions
is more difficult than what expected.
In fact, due to the \textit{Path Exploration} problem, presented in \Cref{sec:bgp_fsm_explosion},
the node will experience an explosion in the number of possible evolutions.
Multiple inputs can lead to the same output of the node, so its not enough to
know it to infer a precise input signal.
Furthermore, \ac{MRAI} can make the situation even more complicated, increasing
the number of transitions.

\section{BGP generalization}
\label{sec:bgp_generalization}

The main idea behind the \ac{BGP} \ac{FSM} is to represent the knowledge as
states and different set of messages as transitions.
The knowledge is represented by the actual routes that the node knows on how 
to reach a single destination.
Transitions encode the messages that a node has received to trigger the state change,
on the edges are also inserted the response messages that the node will transmit.
We can see an example of this transitions in \Cref{fig:fsm_example}

\begin{figure}[h]                                                               
    \begin{center}                                                              
        \input{images/tikzpictures/FSM_example}
    \end{center}                                                                
	\caption{Example of the \ac{BGP} \ac{FSM} state transition}
    \label{fig:fsm_example}                                                   
\end{figure}

In \Cref{fig:fsm_example} there are two states, both represent the knowledge of
the node, the first one represent the \ac{RIB} with just the route \num{1}, in
the second state the \ac{RIB} will contains both the routes \num{1} and \num{3}.
This transition si caused by the reception of the advertisement of the route 
\num{3} and will couse the transmission of an other advertisement.
The opposite transition is caused by the reception of the withdraw of the route
\num{4} with the consequent withdraw of the route \num{4}.

In \ac{BGP} messages transfer information about routes, there could be the advertisement
or the withdraw of the route.

Thanks to \ac{MRAI} the evaluation of multiple messages could be delayed and
provoke then the compression of them.
For this reason on the edges is possible to see multiple messages, for example 
\q{A1W1A1}, that will be compressed in \q{A1} and then evaluated.

The concept for a \ac{BGP} \ac{FSM} has been expanded from \cite{griffinFSM}.

%\begin{itemize}
%    \item BGP as an FSM main idea
%    \item signalling transmutation
%\end{itemize}

\section{BGP FSM experiments}
\label{sec:bgp_fsm_experiments}

The first experiments, about the translation of a single node evolution in a
\ac{FSM}, goal is to reproduce what has been shown in \cite{griffinFSM}.
The graph used for the study is presented in \cref{fig:griffin_fig_4}.

\begin{figure}[h]                                                               
    \begin{center}                                                              
        \input{images/tikzpictures/griffin_fig_4}
    \end{center}                                                                
	\caption{Graph from fig 4 of \cite{griffinFSM} used to study the \ac{FSM}
		of the nodes}                                
    \label{fig:griffin_fig_4}                                                   
\end{figure}

This topology, \Cref{fig:griffin_fig_4}, present an \ac{SPP} with five nodes \cite{griffin2002stable}. 
The \ac{SPP} model is used to eliminate much of the complexity of \ac{BGP}.
The arrows in the graph represent the flow of information, node \num{1} is the one
that will receive a new route to reach a hypothetical destination and it will 
spread this information through an \ac{ADV} to all it neighbours.
The translation to the \ac{CFSM} will use an enumeration to encode all the
paths that a single node will encounter, for example, the path \q{5 3 1} will
be converted in \textit{a3}, each path has its own identifier.
In case of withdraw the route will be encoded as \textit{w3}.

The properties of the environment for this experiment are listed in \Cref{tbl:fig_4_example}.

\begin{table}[h]
	\input{tables/spp_properties}
	\caption{FSM example environment properties}
	\label{tbl:fig_4_example}
\end{table}

The total number of runs generated by this environment is \num{100}.

\fxfatal{this paragraph is cumbersome}
The two nodes of more interest are node \num{4} and node \num{4}.
The first one can receive multiple combinations of messages from node \num{2} and
\num{3}, for sure there will be two announcements and two withdraws because node
1 has to respect a predefined signaling. but, those messages could be reordered
in different ways, and, for each sequence of them we can encounter a different
sequence of output messages through node \num{5}.
Giving that the routes from node \num{2} and \num{3} will have respectively as 
ID \num{2}, \num{3} the table \Cref{tbl:fig_4_node4_possible_inputs}
All possible inputs of node \num{4} are the shuffle of all possible
outputs of nodes \num{2} and \num{3} preserving the local order.

\begin{table}[h]
	\input{tables/spp_node4_inputs}
	\caption{Node 4 different possible inputs and output}
	\label{tbl:fig_4_node4_possible_inputs}
\end{table}

The node \num{5} will receive all the possible outputs from node \num{3} and 
\num{4} increasing the number of possible signals from \num{6} of node \num{4}
up to \num{71} but some of them produce the same output signal, so we have in 
total \num{52} unique output signals from node \num{5}.

From the \num{100} total runs we can generate the \ac{CFSM} of node \num{4} and
node \num{5}, in order to be able to study how the nodes reacts to different
input signals.
The two \ac{CFSM} are presented in \Cref{fig:fsm_griffin_fig4}.

\fxfatal{Remove message table from \Cref{fig:fsm_griffin_fig4}?}
\begin{figure}[h]
     \centering
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/fsm/fig_4_4.pdf}
		 \caption{Node \num{4} \ac{CFSM} from the environment of \Cref{tbl:fig_4_example}}
         \label{fig:fsm_node4}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/fsm/fig_4_5.pdf}
		 \caption{Node \num{5} \ac{CFSM} from the environment of \Cref{tbl:fig_4_example}}
         \label{fig:fsm_node5}
     \end{subfigure}
		\caption{\ac{CFSM} of nodes \num{4} and \num{5} of the graph \Cref{fig:griffin_fig_4} with an input signal of \q{AW}}
        \label{fig:fsm_griffin_fig4}
\end{figure}

The states of the \ac{CFSM} in \Cref{fig:fsm_griffin_fig4} are represented by the
knowledge of the nodes, composed by the routes that are in the \ac{RIB} of the node.
The bold value is the actual best route to the destination chosen by the node.
If in the state transition to a new state the best path is not affected then the
node will not transmit the new route to its neighbours, for an example take
a look to \Cref{fig:fsm_node4} from the state $\{1\}$ to the state $\{1, 3\}$
where the node \num{4} will learn a new route that is not the best one.

The effects of the implicit withdraw can be seen in \Cref{fig:fsm_node5}
the transition from $\{1, 4\}$ to $\{1, 3\}$ thanks to the reception of the
announcement $a3$ from the node \num{4}.

As written in \cite{griffinFSM}, I would like to underline the fact that, given
the \num{52} unique possible outputs of the node \num{5} it would be very difficult
to infer the initial signal that provokes all the transitions.

We can also analyze those output signals, having all the events for each single
run we can infer which were the most common output signals that a single node
experienced.
Is sufficient to take all the transmitted messages of a node and look the sequence
of advertisement and withdraws.

\begin{figure}[h]
     \centering
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fig_4/fig_4_4_signaling_nmessage_prob.pdf}
		 \caption{Node \num{4} output signals study}
         \label{fig:signal_node4}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fig_4/fig_4_5_signaling_nmessage_prob.pdf}
		 \caption{Node \num{5} output signals study}
         \label{fig:signal_node5}
     \end{subfigure}
		\caption{Output signal study of nodes \num{4} and \num{5} of the graph 
			\Cref{fig:griffin_fig_4} with an input signal of \q{AW} at node \num{1}}
        \label{fig:signal_griffin_fig4}
\end{figure}

The plots in \Cref{fig:signal_griffin_fig4} represents the probability of an
output signal of a certain length to appear and the number of unique output signals
of a unique length has been found.
The $x$ axis represents the number of messages in the output signal, a message
is a single announcement or withdraw.
The first $y$ axis represents the probability to see a certain number of messages
taking a random output signal from the output.
For this axis there are three lines that refer to it, the blue one represent the
number of advertisement messages in the output signal correlated with the 
respective probability.
For example, in \Cref{fig:signal_node4} there is a probability around $0.45$ to have
exactly two advertisement messages per output signal. And respectively a probability
slightly larger than $0.25$ to have only one advertisement or three.
We can also notice that we didn't see more than three advertisements or less than one.
The green line instead represents the total number of messages in the signal,
without distinguishing between advertisement and withdraws.
By the fact that we will always have one withdraw (the orange line) this line 
is simply shifted by one unit in respect of the advertisement line.
The second $y$ axis refers to the number of unique output signals encountered and
their length.
For example, in \Cref{fig:signal_node5} we will have \num{1} unique output signal
of length \num{2}, \num{3} signals of length \num{3} and \num{4} of length \num{4} and \num{2} of length \num{5}.

Those plots do not give a complete prospective of all the possible outputs
that can be generated but only the ones encountered during the runs.
In fact, during the \num{100} runs we encountered only the output signals listed
in \cref{tbl:signals}.

\begin{table}[h]
	\begin{subtable}[h]{0.45\textwidth}
		\input{tables/node4_outSignals}
		\caption{Node \num{4} output signals encountered}
		\label{tab:node4_outSignals}
    \end{subtable}
	\hfill
	\begin{subtable}[h]{0.45\textwidth}
		\input{tables/node5_outSignals}
		\caption{Node \num{5} output signals encountered}
		\label{tab:node5_outSignals}
    \end{subtable}
	\caption{Node 4 and 5 different output signals encountered during the runs}
	\label{tbl:signals}
\end{table}


\subsection{MRAI and BGP FSM}
\label{subsec:mrai_vs_bgpfsm}

How would \ac{MRAI} affect the study of the signals produced by \Cref{fig:griffin_fig_4}?
The answer is that the number of states will be the same but the number of possible
transitions will explode because there will be a lot more possible
input signals that will be compressed and evaluated by the nodes.

We can see the effects of \ac{MRAI} on the \ac{CFSM}s in \Cref{fig:fsm_griffin_fig4_MRAI}.

\fxfatal{\Cref{fig:fsm_node5_MRAI} is not readable at all, move the two figure
	one after the other}
\begin{figure}[h]
     \centering
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/fsm/fig_4_4_MRAI30.pdf}
		 \caption{Node \num{4} \ac{CFSM} from the environment of \Cref{tbl:fig_4_example} with \ac{MRAI}=\SI{30}{\second}}
         \label{fig:fsm_node4_MRAI}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/fsm/fig_4_5_MRAI30.pdf}
		 \caption{Node \num{5} \ac{CFSM} from the environment of \Cref{tbl:fig_4_example} with \ac{MRAI}=\SI{30}{\second}}
         \label{fig:fsm_node5_MRAI}
     \end{subfigure}
		\caption{\ac{CFSM} of nodes \num{4} and \num{5} of the graph 
			\Cref{fig:griffin_fig_4} with an input signal of \q{AW} with
			\ac{MRAI}=\SI{30}{\second}}
        \label{fig:fsm_griffin_fig4_MRAI}
\end{figure}

\Cref{fig:fsm_node4} and \Cref{fig:fsm_node4_MRAI} permits us to compare the two
\ac{CFSM}s of node \num{4} and is possible to nice a big difference in terms of edges
between one figure and the other, the first one has \num{8} transitions, the
second one \num{15}.
For the node \num{5} we pass from \num{16} transitions to \num{36}.

But the positive effects of \ac{MRAI} can be found in the output signals, 
showed in \Cref{fig:signal_griffin_fig4_MRAI}.

\begin{figure}[h]
     \centering
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fig_4_MRAI/fig_4_4_signaling_nmessage_prob.pdf}
		 \caption{Node \num{4} output signals study with \ac{MRAI}=\SI{30}{\second}}
         \label{fig:signal_node4_MRAI}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fig_4_MRAI/fig_4_5_signaling_nmessage_prob.pdf}
		 \caption{Node \num{5} output signals study with \ac{MRAI}=\SI{30}{\second}}
         \label{fig:signal_node5_MRAI}
     \end{subfigure}
		\caption{Output signal study of nodes \num{4} and \num{5} of the graph 
			\Cref{fig:griffin_fig_4} with an input signal of \q{AW} at node \num{1}
			with \ac{MRAI}=\SI{30}{\second} for every link}
        \label{fig:signal_griffin_fig4_MRAI}
\end{figure}

Comparing \Cref{fig:signal_node5_MRAI,fig:signal_node5} is possible to notice
that there is a different distribution of output signals.
The $x$ axis never reach the value of \num{5}, this means that the output signals
of the node \num{5} never used more than \num{4} messages.
And we can also notice that the majority of the signals this time have a length
of \num{3} messages, instead of the previous \num{4}.
This is a hint that \ac{MRAI} can have positive effects on the number of output messages
produced by single nodes, having, however, more possible transitions to consider.

\section{BGP FSM explosion}
\label{sec:bgp_fsm_explosion}

We know that \ac{MRAI} is not an easy parameter, the incorrect setting of
it can lead to an explosion of messages and an exponential convergence time.
This problem has been studied by Fabrikant et al. \cite{fabrikant2011there} and
the origin of the problem has been attributed to the \textit{path exploration}
problem.
This is a well-known problem in the \ac{BGP} community and it is experienced
by a node when it enters in a transitory phase where it accepts and publishes not
optimal paths towards the destination before reaching a stable state.
\textit{Path exploration} can lead to an enormous amount of messages even with
a small set of nodes \cite{deshpande2004impact}.

As we saw in \Cref{subsec:mrai_vs_bgpfsm} that \ac{MRAI} can influence the
\ac{CFSM}s of the nodes and their output signals, which impact could it have
if it is not set correctly?

I have then created an environment that resembles the study conducted by
\cite{fabrikant2011there} using a topology like the one described in \Cref{subsec:fabrikant_env}
with \num{3} rings.
with different \ac{MRAI} settings.
The environment properties are presented in \Cref{tbl:fabrikant_environment}.

\begin{table}[h]
	\input{tables/fabrikant_properties}
	\caption{Fabrikant experiments environment}
	\label{tbl:fabrikant_environment}
\end{table}

In total, for each signaling experiment this environment produces \num{240} runs.
I have then introduced \num{4} different \ac{MRAI} strategies for each different
signal.
The different \ac{MRAI} strategies are the following one:
\begin{itemize}
	\item \textbf{\textit{Fixed \SI{30}{\second}}}: \ac{MRAI} is fixed for each link to \SI{30}{\second};
	\item \textbf{\textit{No \ac{MRAI}}}: \ac{MRAI} is fixed for each link to \SI{0.0}{\second};
	\item \textbf{\textit{Ascendant}}: \ac{MRAI} will be doubled at each leach (1 − 2 − 4 − 8 − ...);
	\item \textbf{\textit{Descendent}}: Reverse of the ascendant case, \ac{MRAI} will be divided by two at each leach.
\end{itemize}

Another important factor to consider during those experiments is the \ac{IW}
capability of \ac{BGP}.
This parameter will influence the number of messages
that will be transmitted.

The results of all those different experiments, in terms of \ac{CFSM} are
exposed in \Cref{tbl:fabrikant_cfsm}

\begin{table}[h]
	\input{tables/fabrikant_cfsm_results}
	\caption{Fabrikant \ac{CFSM}s results, $|S|$ is the dimension of the states set
		$|T|$ is the dimension of the transitions set, The worst results for each
		category are colored in gray, the topology contains \num{3} rings, as
		\Cref{fig:fabrikant_topology}}
	\label{tbl:fabrikant_cfsm}
\end{table}

As is possible to see from the grey squares in \Cref{tbl:fabrikant_cfsm} the more
complex \ac{CFSM}s are the ones without \ac{MRAI} and with a descendent \ac{MRAI}
timing.
The second case is the same described in \cite{fabrikant2011there} and the extremely
high number of transitions is caused by the \textit{Path Exploration} problem.
Is also noticeable that the \ac{IW} has a huge effect on both the number
of states and the number of transitions.
This because there are less possible combinations of input signals for the nodes.
The opposite case in respect of the \textit{Descendent} strategy obtains
great results, even better than the actual standard of \SI{30}{\second} for
each link.
This performance improvement is caused by the fact that each leach will wait
enough time to have more information from its predecessor in order to have
more information to make the best decision.

The \textit{Path Exploration} problem is also noticeable evaluating the
output signals of the last node of the chain.
Results about the output signal of the node \num{8} (the last node of the gadget)
are presented in \Cref{fig:signal_fabrikant}.

\begin{figure}[ht]
     \centering
     \begin{subfigure}[b]{0.32\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fabrikant/30Fixed.pdf}
		 \caption{Node \num{8} output signals study with \textbf{\textit{Fixed \SI{30}{\second}}} strategy}
         \label{fig:signal_node9_fabrikant_fixed30_noIW}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.32\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fabrikant/Descendent.pdf}
		 \caption{Node \num{9} output signals study with \textbf{\textit{Descendent}} strategy}
         \label{fig:signal_node9_fabrikant_descendent_noiw}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.32\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/signal_study/fabrikant/Ascending.pdf}
		 \caption{Node \num{9} output signals study with \textbf{\textit{Ascendant}} strategy}
         \label{fig:signal_node9_fabrikant_ascendent_noIW}
     \end{subfigure}
		\caption{Output signal study of nodes \num{8} of the graph 
			\Cref{fig:fabrikant_topology} with an input signal of \q{AWA} at node $d$
			with the \textbf{\textit{Fixed \SI{30}{\second}}}, \textbf{\textit{Descendent}}
			and \textbf{\textit{Ascendant}}	strategies, without the help of the \ac{IW}}
        \label{fig:signal_fabrikant}
\end{figure}

The first signal study, \Cref{fig:signal_node9_fabrikant_fixed30_noIW} is the
one that represents the actual standard of the protocol \cite{rfc4271}.
We can notice in that particular output study that the maximum detected length of
a signal is \num{13} and it's the last probable output, while the most probable
output length is \num{5}.
While we can notice the \textit{Path Exploration} problem by the spike of unique
output signals with a length of \num{9}, this mean that the node experienced some
changes in its decisions.
The worst-case scenario is the one represented by \cref{fig:signal_node9_fabrikant_descendent_noiw}
where the maximum length of the output signal reaches almost \num{40} messages, but
the most probable output signal has a length between \num{20} and \num{30}.
This is the marker of a lot of decision changes in the best path for the node \num{8}.
Opposite to that case, we found the \textit{Ascendent} strategy in 
\Cref{fig:signal_node9_fabrikant_ascendent_noIW} where the number of output
signals never used more than \num{7} messages.
The node \num{8} in this last case almost never experienced the \textit{Path Exploration}
problem, thanks to the fact that most of the times the information it receives
from the neighbourhood are already corrected.

In conclusion of this chapter, we can say without doubts that \ac{MRAI} influences
the number of states experienced by a node and, confirming what has been sad in
\cite{fabrikant2011there}, that an incorrect setting of it can lead
to an explosion on the number of states and transitions.
It is also noticeable that a different setting of \ac{MRAI} can also lead
to a better scenario than the standard one.
Alternatives to the standard \ac{MRAI} has been already presented \fxfatal{Include
citations and maybe find a better end of the chapter}
