\chapter{Discrete Event Simulator}
\label{cha:des}

Experiments on \ac{BGP} are not applicable on the Internet, for this
reason different studies shows their results using a simulate environment
\cite{griffin2001experimental} \fxfatal{Insert other citations}.
The majority of the studies uses small graphs, and each node 
of the graph simulate the behaviour of a \ac{BGP} speaker.
Each node represent also a single \ac{AS} and the \ac{BGP} speaker is it's own
exterior router, for simplicity reduced to one speaker that handles all the
connections.
 
For this reason I decided to use and expand a \ac{DES} that permits to have
different grades of freedom, respecting on the other side all the properties
required for a reliable simulator environment.
I decided to use the \textit{Simpy}\footnote{\href{https://simpy.readthedocs.io/en/latest/index.html}{Simpy website}}
package to make the environment evolve. I decided for this package for the
extensive documentation and because it has been already used for different
studies, demonstrating its adaptability \cite{matloff2008introduction,dagkakis2013manpy}.

I developed the \ac{DES} as a highly modular environment.
\begin{figure}[h]                                                               
    \begin{center}                                                              
        \input{images/tikzpictures/des}
    \end{center}                                                                
    \caption{Discrete event simulator structure}                                
    \label{fig:des_structure}                                                   
\end{figure}
In \Cref{fig:des_structure} is possible to see the basic idea of the simulator.
The first component needed is a graph, represented by a \textit{graphml} file, this file is 
descriptor of the network. it defines also all topological information and all the
properties of each single node.
\fxfatal{Look for a Cref implementation of this}
In Code \ref{lst:graph_example} is possible to see an example of a \textit{graphml} file,
it describes that node \num{0} contains a single destination and that the edge
between nodes \num{2} and \num{5} is controlled by the policy |2, 2, 2| that defines
a servicer-provider policy.
Policies are encoded using the convention described in \cite{daggitt2018rate}.

\lstcaptionname{Code}
\begin{lstlisting}[language=graphml, caption=Graph example, label=lst:graph_example]
 <node id="0">
      <data key="d0">10.0.0.0/24</data>
 </node>
 <edge source="2" target="5">                                                  
     <data key="d2">2, 2, 2</data>                                             
 </edge> 
\end{lstlisting}

The graph is then embedded in the environment file, this file is in \textit{json}
format and it describes how the environment is characterized, it gives the
initial values for the \ac{RNG} so that each experiment is replicable and
other properties, like where the output should be saved, and, most importantly
how the experiment should be conducted.
There are two possible evolution of the environment:
\begin{itemize}
    \item \textbf{\textit{Continuous evolution}}: In this category all the nodes
    that contains at least a destination will continuously share and retrieve
    the destination accordingly with the distributions defined in the environment;
    \item \textbf{\textit{Signaling evolution}}: Is possible to define a precise
    signal that should be executed by the nodes that contains a destination, for 
    example, the signal \q{AWA} defines that there will be an announce followed by 
    a withdraw and the an other announce.
\end{itemize}

The \ac{DES} take as input this \textit{json} file where all the information
are described, it creates an object for each node in the graph file, with
each own characteristics.
After the initialization all the nodes that contains a destination will schedule
the first advertisement of it to their neighbour.
The simulation run will terminate only if there are no more events scheduled or
if the maximum simulation time is reached.

The \ac{DES} will then produce a \textit{CSV} output, with all the events that 
can be analyzed to see the evolution of a specific node or to evaluate the
whole network.
 
\section{DES Environments}
\label{sec:des_environment}

\begin{itemize}
    \item Example environment
    \item Explanation of more complex environments
    \item Internet like graphs
    \item Fabrikant Graphs
\end{itemize}

Thanks to the environment codification in a \textit{json} file is possible to
define experiments with a high grade of freedom.
Is possible to define multiple delays as probability functions vectors that
will provide multiple runs possibility. For example, if we have \num{5} different
possible seeds and \num{3} different delays, the total number of runs combinations
is \num{15}, as showed in Code \ref{lst:environment_example}.
is possible to run one of the possible combination of parameters through the identifier
of the single run.

\lstcaptionname{Code}
\begin{lstlisting}[language=json, caption=Environment example, label=lst:environment_example]
"simulation" : {                                                              
    // seed(s) to initialize RNG                                      
    "seed" : [0, 1, 2, 3, 4], 
    ....
    // Multiple withdraw distributions
    "withdraw_dist": [{"distribution": "unif", "min": 5, "max": 10, "int": 0.1},
                      {"distribution": "unif", "min": 8, "max": 10, "int": 0.1},
                      {"distribution": "unif", "min": 2, "max": 3, "int": 0.1}],       
    ....
}
\end{lstlisting}

In the environment is possible to define also the processing time, this time is used
inside each \ac{BGP} node to emulate the processing of information or the evaluation
of a packet.
Though the \textit{delay} parameter is possible to define the default delay on the edges,
is important to remember that the links are FIFO so there is no reordering
of messages in the same link, there is also no messages lost.
That because it was out of the scope of this thesis to study the evolution
of the protocol with packet loss, but it could be a future work.

\subsection{Clique environment}
\label{subsec:clique_env}

One of the special environment that I used it's composed by a clique graph
graph of different dimensions, an example of clique graph is given in
\Cref{fig:clique_graph}.

\begin{figure}[h]                                                               
    \begin{center}                                                              
        \input{images/tikzpictures/clique_graph}
    \end{center}                                                                
    \caption{Clique graph example}                                
    \label{fig:clique_graph}
\end{figure}

The only node that shares a destination is the node \q{\textit{d}}, the node
\num{0} will then spread the knowledge to the whole network, and the node 
\q{\textit{x}} will act as a black hole for all the possible paths
that the node \num{5} will share.
This topology is used to enforce the path exploration problem.

\subsection{Fabrikant environment}
\label{subsec:fabrikant_env}

Another interesting chase to test the path exploration problem is the one
presented in \cite{fabrikant2011there}.
In that study Fabrikant et al. presents how particular \ac{MRAI} setting could 
make the network converge with an exponential bechaviour because of the path
exploration problem.
I used the basic example of their study to investigate how the choose of \ac{MRAI}
is foundamental for the network convergence.
An example of the network used is presented 
in \Cref{fig:fabrikant_graph}.

\begin{figure}[h]                                                               
    \begin{center}                                                              
        \input{images/tikzpictures/fabrikant_graph}
    \end{center}                                                                
    \caption{Fabrikant chain graph example}                                
    \label{fig:fabrikant_graph}
\end{figure}

The path exploration problem is caused by the delay on the node \num{0}-\num{2}
edge. The node 2 will receive the destination through node 1, after a small ammount
of time the network will converge to the best path (without using the backup links).
But, after a while, node \num{2} will receive the network also through node \num{0}
and it will prefer this new path, provoking then the riconfiguration of all
the other nodes that will use the backup links for a while, announcing their 
new path.
A wrong configuration of \ac{MRAI} can provoke the entire exploration of the 
possibility set.

\subsection{Internet-like environment}
\label{subsec:internet_like_env}

The last noteworthy environment is the one whose purpose is to simulate Internet
behaviour.
This has been possible thanks to the study by Elmokashfi et al. \cite{elmokashfi2010scalability}
and the internet like graph generator present in Networkx\footnote{\href{https://networkx.org/documentation/stable/reference/generated/networkx.generators.internet_as_graphs.random_internet_as_graph.html#networkx.generators.internet_as_graphs.random_internet_as_graph}{Networkx internet as graph generator}}
(a python library famous for graph and network studies).
An example with a small set of nodes is presented in \Cref{fig:internet_graphs}

\begin{figure}[h]
     \centering
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/internet_graph/graph-100-colored.pdf}
		 \caption{Internet like graph with an \q{explosive} layout}
         \label{fig:internet_graph_explosive}
     \end{subfigure}
     \hfill
     \begin{subfigure}[b]{0.45\textwidth}
         \centering
         \includegraphics[width=\textwidth]{images/internet_graph/graph_dot.pdf}
		 \caption{Internet like graph with a \q{hierarchical} layout}
         \label{fig:internet_graph_hierarchical}
     \end{subfigure}
        \caption{Internet like graph colored to show the hierarchicaly structure,
4 tipes of nodes, T (tier 1 mesh), M, CP, C (Customers, purple one)}
        \label{fig:internet_graphs}
\end{figure}

The different nodes are colored accordingly with the node type represented.
The tier one nodes that generate the centrali clique are colored in red, and
is possible to notice in \Cref{fig:internet_graph_hierarchical} that them are
in the highest levels of the networks.
This environment has been used to study the behaviour of the network with 
topologies resempbling the real internet.
